jsCow.res.components.nodeeditor=function(){},jsCow.res.components.nodeeditor.prototype={init:function(){return this.addController(jsCow.res.controller.nodeeditor),this.addModel(jsCow.res.model.nodeeditor),this.addView(jsCow.res.view.nodeeditor),this},addNode:function(options){var list=[];return options instanceof Array?list=options:list.push(options),this.trigger("nodes.add",{nodes:list}),this},addConnection:function(options){var list=[];return options instanceof Array?list=options:list.push(options),this.trigger("connection.add",{connections:list}),this},removeConnection:function(options){var list=[];return options instanceof Array?list=options:list.push(options),this.trigger("connection.remove",{connections:list}),this},removeNode:function(id){return"String"==typeof options&&this.trigger("node.remove",{id:id}),this},addNodesRepository:function(repo){return"object"==typeof repo&&this.trigger("editor.repository.add",{repository:repo}),this}},jsCow.res.model.nodeeditor=function(){this.data={enabled:!0,visible:!0,options:{grid:20,snapToGrid:!0,autosave:!0},nodes:{},connections:[],repositories:{}}},jsCow.res.model.nodeeditor.prototype={init:function(){this.trigger("model.ready",this.data)}},jsCow.res.view.nodeeditor=function(){this.config={contentSize:{width:null,height:null},grid:{data:[]},jsPlumbInstance:null,newNodePos:{left:0,top:0}},this.dom={},this.dom.main=$("<div/>").addClass("jsc-nodeeditor"),this.dom.grid=$("<div/>").addClass("jsc-nodeeditor-grid").appendTo(this.dom.main),this.dom.content=$("<div/>").addClass("jsc-nodeeditor-content").on("dblclick",function(self){return function(e){self.config.newNodePos={left:e.offsetX-85,top:e.offsetY-10},self.dom.nodeselector.slideDown().find("input").focus()}}(this)).appendTo(this.dom.grid),this.dom.nodeselector=$("<div/>").addClass("jsc-nodeeditor-nodeselector").attr("data-keyboard-focus-group","").hide().appendTo(this.dom.main),this.dom.nodeselectorinputcontainer=$("<div/>").addClass("jsc-nodeeditor-nodeselectorinputcontainer").appendTo(this.dom.nodeselector),this.dom.nodeselectorinput=$('<input type="text" value="" placeholder="Search..." />').attr("data-keyboard-focus","").appendTo(this.dom.nodeselectorinputcontainer),this.dom.nodeselectorresults=$("<ul/>").appendTo(this.dom.nodeselector)},jsCow.res.view.nodeeditor.prototype={init:function(e){this.on("editor.node.added",this.editorNodeAdded),this.on("editor.node.updated",this.editorNodeUpdated),this.on("editor.node.types.updated",this.onEditorNodeTypesUpdated),this.on("editor.connection.added",this.editorConnectionAdded),this.on("node.remove",this.nodeRemove),this.on("editor.grid.update",this.updateGrid),this.dom.grid.kinetic(),this.dom.svggrid=d3.select(this.dom.content[0]).append("svg:svg").attr("width","100%").attr("height","100%"),jsPlumb.ready(function(self){return function(){self.config.jsPlumbInstance=jsPlumb.getInstance(),self.config.jsPlumbInstance.setContainer(self.dom.content),self.config.jsPlumbInstance.bind("connectionDragStop",function(connection){if(connection.source&&connection.target){var from=connection.sourceId.split("-"),to=connection.targetId.split("-");self.cmp().addConnection({from:{node:from[from.length-2],out:from[from.length-1]},to:{node:to[to.length-2],"in":to[to.length-1]}}),console.info("ADD CONNECTION",connection.id)}}),self.config.jsPlumbInstance.bind("beforeDrop",function(info){return info.sourceId===info.targetId?!1:void 0})}}(this)),this.dom.nodeselectorinput.keyup(function(self){return function(e){if(console.log(e.keyCode),27===e.keyCode)self.dom.nodeselector.fadeOut();else if(40===e.keyCode)self.dom.nodeselector.find("div[data-keyboard-focus]:visible").eq(0).focus();else{var searchString=self.dom.nodeselectorinput.val();if(""!==searchString){var foundItem=self.dom.nodeselectorresults.find("div").not(':contains("'+self.dom.nodeselectorinput.val()+'")');foundItem.hide(),1===self.dom.nodeselectorresults.find("div:visible").length&&self.dom.nodeselectorresults.find("div:visible").eq(0).focus()}else self.dom.nodeselectorresults.find("div").show()}}}(this)),this.trigger("editor.node.types.updated",this.cmp().config().repositories),this.trigger("view.update",e.data)},update:function(e){e.data.enabled?(this.dom.main.removeClass("jsc-nodeeditor-disabled").addClass("jsc-nodeeditor"),e.data.visible?this.dom.main.show():this.dom.main.hide()):this.dom.main.removeClass("jsc-nodeeditor").addClass("jsc-nodeeditor-disabled")},editorNodeAdded:function(e){var self=this,cfg=this.cmp().config(),nodeOptions=e.data;nodeOptions.grid=cfg.options.grid,nodeOptions.snapToGrid=cfg.options.snapToGrid,nodeOptions.jsPlumbInstance=this.cfg.jsPlumbInstance;var main=$("<div/>").attr("id",this.cmp().id()+"-"+nodeOptions.id).addClass("jsc-node clearfix").css({top:nodeOptions.pos.top,left:nodeOptions.pos.left}),content=$("<div/>").addClass("jsc-node-content clearfix").appendTo(main),titlebar=$("<div/>").addClass("jsc-node-titlebar").append($("<span/>").html(nodeOptions.title));main.prepend(titlebar);var outputs=($("<i/>").addClass("jsc-node-remove fa fa-times").click(function(e){self.trigger("node.remove",{id:nodeOptions.id})}).appendTo(titlebar),$("<div/>").addClass("jsc-node-outputs").appendTo(content));$("<div/>").addClass("jsc-node-preview").appendTo(content);if(nodeOptions.config)for(var config=$("<div/>").addClass("jsc-node-config").appendTo(content),onNodeConfigChanged=function(){console.log(e.data)},c=0;c<nodeOptions.config.length;c++)jsCow.get(nodeOptions.config[c].type,{model:{value:nodeOptions.config[c].value,title:nodeOptions.config[c].title}}).on("node.config.changed",onNodeConfigChanged).target(config).run();var inputs=$("<div/>").addClass("jsc-node-inputs").appendTo(content);$.each(nodeOptions.outputs,function(i,output){var id=self.cmp().id()+"-"+nodeOptions.id+"-"+output.id,port=$("<div/>").addClass("jsc-node-port jsc-node-port-out").attr("id",id),portContent=$("<div/>").appendTo(port);output.title&&portContent.append($("<span/>").text(output.title)),output.type&&jsCow.get(output.type,{model:{value:output.value}}).on("node.port.changed",function(e){for(var ports=self.cmp().config().nodes[nodeOptions.id].outputs,p=0;p<ports.length;p++)output.id===ports[p].id&&(self.cmp().config().nodes[nodeOptions.id].outputs[p].value=e.data.value,self.trigger("editor.save"))}).target(portContent).run(),outputs.append(port),window.setTimeout(function(){self.config.jsPlumbInstance.makeSource(id,{anchor:["RightMiddle"],isSource:!0,sourceDetachable:!0})},0)}),$.each(nodeOptions.inputs,function(i,input){var id=self.cmp().id()+"-"+nodeOptions.id+"-"+input.id,port=$("<div/>").addClass("jsc-node-port jsc-node-port-in").attr("id",id),portContent=$("<div/>").appendTo(port);input.title&&portContent.append($("<span/>").text(input.title)),input.type&&jsCow.get(input.type,{model:{value:input.value}}).on("node.port.changed",function(e){for(var ports=self.cmp().config().nodes[nodeOptions.id].inputs,p=0;p<ports.length;p++)input.id===ports[p].id&&(self.cmp().config().nodes[nodeOptions.id].inputs[p].value=e.data.value,self.trigger("editor.save"))}).target(portContent).run(),inputs.append(port),window.setTimeout(function(){self.config.jsPlumbInstance.makeTarget(id,{anchor:["LeftMiddle"],isTarget:!0,targetReattach:!0})},0)}),this.dom.content.append(main),this.config.jsPlumbInstance.draggable(this.cmp().id()+"-"+nodeOptions.id,{grid:[nodeOptions.grid,nodeOptions.grid],stop:function(e){self.cmp().config().nodes[nodeOptions.id].pos={left:e.pos[0],top:e.pos[1]},self.trigger("editor.save")}})},editorNodeUpdated:function(e){e.data},editorConnectionAdded:function(e){var self=this,c=e.data;jsPlumb.ready(function(){var connectorOptions={connector:["Bezier",{curviness:100},{cssClass:"jsc-connector-bezier"}],anchor:["RightMiddle","LeftMiddle"],endpoint:["Dot",{radius:5}],overlays:[["Label",{cssClass:"jsc-connector-label",label:"x",location:.5,events:{click:function(labelOverlay,originalEvent){var from=labelOverlay.component.sourceId.split("-"),to=labelOverlay.component.targetId.split("-"),con={from:{node:from[from.length-2],out:from[from.length-1]},to:{node:to[to.length-2],"in":to[to.length-1]}};self.config.jsPlumbInstance.detach(labelOverlay.component),self.cmp().removeConnection(con),console.info("REMOVED CONNECTION",labelOverlay,labelOverlay.component.id,con)}}}]]};c.color?connectorOptions.paintStyle={strokeStyle:c.color}:connectorOptions.cssClass="jsc-connector-path";var source=self.cmp().id()+"-"+c.from.node+"-"+c.from.out,target=self.cmp().id()+"-"+c.to.node+"-"+c.to["in"];self.config.jsPlumbInstance.connect({source:source,target:target},connectorOptions)})},nodeRemove:function(e){var nodeId=e.data.id,connections=(this.cmp().config().nodes,this.cmp().config().connections),nodeElementId=this.cmp().id()+"-"+nodeId;$("#"+nodeElementId).remove();for(var allJsPlumbConnections=this.config.jsPlumbInstance.getConnections(),searchId="-"+nodeId+"-",pc=0;pc<allJsPlumbConnections.length;pc++)-1===allJsPlumbConnections[pc].sourceId.indexOf(searchId)&&-1===allJsPlumbConnections[pc].targetId.indexOf(searchId)||this.config.jsPlumbInstance.detach(allJsPlumbConnections[pc]);for(var c=0;c<connections.length;c++)connections[c].from.node!==nodeId&&connections[c].to.node!==nodeId||this.cmp().removeConnection(connections[c])},onEditorNodeTypesUpdated:function(e){var nodeTypeGroups=e.data;this.dom.nodeselectorresults.find("*").remove();var typeHoverHandler=function(self,type){return function(e){this.focus()}},typeClickHandler=function(self,type){return function(){type.id=("node"+Math.random()).replace(".",""),type.pos={left:self.config.newNodePos.left,top:self.config.newNodePos.top},self.cmp().addNode(type)}},typeKeyHandler=function(self,type){return function(e){var currentFocusElement,currentFocusGroupItems,prevIndex,nextIndex;27===e.keyCode&&self.dom.nodeselector.fadeOut(),38===e.which&&(currentFocusElement=$(":focus"),currentFocusGroupItems=currentFocusElement.closest("[data-keyboard-focus-group]").find("[data-keyboard-focus]:visible"),prevIndex=currentFocusGroupItems.index(currentFocusElement)-1,0>prevIndex?self.dom.nodeselectorinput.focus():$(currentFocusGroupItems).eq(prevIndex).focus()),40===e.which&&(currentFocusElement=$(":focus"),currentFocusGroupItems=currentFocusElement.closest("[data-keyboard-focus-group]").find("[data-keyboard-focus]:visible"),nextIndex=currentFocusGroupItems.index(currentFocusElement)+1,$(currentFocusGroupItems).eq(nextIndex).focus()),13===e.which&&$(":focus").click()}};for(var key in nodeTypeGroups){this.dom.nodeselectorresults.append('<li class="jsc-nodeeditor-nodegroup">'+nodeTypeGroups[key].title+"</li>");for(var item=$("<li/>"),t=0;t<nodeTypeGroups[key].types.length;t++){var type=nodeTypeGroups[key].types[t],typeButton=$("<div>"+type.title+"</div>").attr("data-keyboard-focus","").attr("tabindex","-1");typeButton.on("click",typeClickHandler(this,type)).on("keyup",typeKeyHandler(this,type)).on("mouseover",typeHoverHandler(this,type)).appendTo(item)}this.dom.nodeselectorresults.append(item),this.dom.nodeselectorresults.find("div").eq(0).focus()}}},jsCow.res.controller.nodeeditor=function(){},jsCow.res.controller.nodeeditor.prototype={init:function(){this.on("model.ready",this.isModelReady),this.on("nodes.add",this.addNode),this.on("node.remove",this.nodeRemove),this.on("connection.add",this.addConnection),this.on("connection.remove",this.removeConnection),this.on("editor.repository.add",this.addNodesRepository),this.on("editor.save",this.editorOptionsChanged)},isModelReady:function(){this.trigger("view.init",this.cmp().config())},editorOptionsChanged:function(e){this.trigger("editor.options.changed",this.cmp().config())},addNode:function(e){var newNodesList=e.data.nodes,nodes=this.cmp().config().nodes;if($.isEmptyObject(nodes))for(i=0;i<newNodesList.length;i++)nodes[newNodesList[i].id]=newNodesList[i],this.trigger("editor.node.added",newNodesList[i]),console.info("NODE ADDED",newNodesList[i]);else for(var nn=0;nn<newNodesList.length;nn++){nodes=this.cmp().config().nodes;var updateNode={};updateNode[newNodesList[nn].id]=newNodesList[nn],"undefined"==typeof nodes[newNodesList[nn].id]?(nodes[newNodesList[nn].id]={},nodes[newNodesList[nn].id]=updateNode,this.trigger("editor.node.added",newNodesList[nn]),console.info("NODE ADDED",newNodesList[nn])):(nodes[newNodesList[nn].id]=updateNode,this.trigger("editor.node.updated",newNodesList[nn]),console.info("NODE UPDATED",newNodesList[nn]))}},addConnection:function(e){for(var nodes=this.cmp().config().nodes,connections=this.cmp().config().connections,newConnections=e.data.connections,i=0;i<newConnections.length;i++){var nodeExists=!1,connectionExists=!1;if(nodes[newConnections[i].from.node]&&nodes[newConnections[i].to.node]){nodeExists=!0;for(var c=0;c<connections.length;c++)connections[c].from.node===newConnections[i].from.node&&connections[c].from.out===newConnections[i].from.out&&connections[c].to.node===newConnections[i].to.node&&connections[c].to["in"]===newConnections[i].to["in"]&&(connectionExists=!0)}!connectionExists&&nodeExists&&(console.info("CONNECTION ADDED",newConnections[i]),this.cmp().config({connections:connections.concat(newConnections[i])}),this.trigger("editor.connection.added",newConnections[i]),connections=this.cmp().config().connections)}},removeConnection:function(e){for(var connections=(this.cmp().config().nodes,this.cmp().config().connections),removeConnections=e.data.connections,i=0;i<removeConnections.length;i++)for(var c=0;c<connections.length;c++)connections[c].from.node===removeConnections[i].from.node&&connections[c].from.out===removeConnections[i].from.out&&connections[c].to.node===removeConnections[i].to.node&&connections[c].to["in"]===removeConnections[i].to["in"]&&connections.splice(c,1)},nodeRemove:function(e){var nodeId=e.data.id,nodes=this.cmp().config().nodes;nodes[nodeId]&&(delete this.cmp().config().nodes[nodeId],console.info("NODE DELETED",nodeId))},addNodesRepository:function(e){var repositories=this.cmp().config().repositories,newRepo=e.data.repository;repositories[newRepo.group]?(repositories[newRepo.group].types.push(newRepo.types),this.cmp().config({repositories:repositories}),this.trigger("editor.node.types.updated",this.cmp().config().repositories)):(repositories[newRepo.group]=newRepo,this.cmp().config({repositories:repositories}),this.trigger("editor.node.types.updated",this.cmp().config().repositories))}},jsCow.res.components.nodetypeinput=function(){},jsCow.res.components.nodetypeinput.prototype={init:function(){return this.addController(jsCow.res.controller.nodetypeinput),this.addModel(jsCow.res.model.nodetypeinput),this.addView(jsCow.res.view.nodetypeinput),this}},jsCow.res.model.nodetypeinput=function(){this.data={enabled:!0,visible:!0,value:null}},jsCow.res.model.nodetypeinput.prototype={init:function(){this.trigger("model.ready",this.data)}},jsCow.res.view.nodetypeinput=function(){this.dom={},this.dom.main=$("<label/>").addClass("jsc-node-type-input"),this.dom.title=$("<div/>").addClass("jsc-node-type-input-title").appendTo(this.dom.main),this.dom.content=$('<input type="text" value="" />').addClass("jsc-node-type-input-content").appendTo(this.dom.main)},jsCow.res.view.nodetypeinput.prototype={init:function(e){var self=this;this.dom.content.on("click",function(e){e.stopPropagation(),e.preventDefault()}).on("change",function(e){var value={value:self.dom.content.val()};self.cmp().config(value),self.trigger("node.config.changed",value)}),this.trigger("view.update",e.data)},update:function(e){e.data.enabled?(this.dom.main.removeClass("jsc-node-type-input-disabled").addClass("jsc-node-type-input"),console.log(e.data),e.data.title&&this.dom.title.html(e.data.title),e.data.visible?this.dom.main.show():this.dom.main.hide()):this.dom.main.removeClass("jsc-node-type-input").addClass("jsc-node-type-input-disabled")}},jsCow.res.controller.nodetypeinput=function(){},jsCow.res.controller.nodetypeinput.prototype={init:function(){this.on("model.ready",this.isModelReady),this.on("title",this.title)},isModelReady:function(){this.trigger("view.init",this.cmp().config())}},jsCow.res.components.node=function(){},jsCow.res.components.node.prototype={init:function(){return this.addController(jsCow.res.controller.node),this.addModel(jsCow.res.model.node),this.addView(jsCow.res.view.node),this},title:function(title){return"undefined"!=typeof title&&"string"==typeof title&&this.trigger("title",{title:title}),this},inputs:function(params){return"undefined"!=typeof params&&"string"==typeof params&&this.trigger("inputs",{inputs:params}),this},outputs:function(params){return"undefined"!=typeof params&&"string"==typeof params&&this.trigger("inputs",{outputs:params}),this},addInPorts:function(ports){return"undefined"!=typeof options&&typeof options instanceof Array&&this.trigger("addInPorts",{ports:ports}),this}},jsCow.res.model.node=function(){this.data={enabled:!0,visible:!0,title:"",pos:{left:null,top:null},inputs:[],outputs:[],config:{},preview:{}}},jsCow.res.model.node.prototype={init:function(){this.trigger("model.ready",this.data)}},jsCow.res.view.node=function(){this.dom={},this.dom.main=$("<div/>").addClass("jsc-node clearfix"),this.dom.content=$("<div/>").addClass("jsc-node-content clearfix").appendTo(this.dom.main),this.dom.titlebar=$("<div/>").addClass("jsc-node-titlebar"),this.dom.title=$("<span/>").appendTo(this.dom.titlebar),this.dom.remove=$("<i/>").addClass("jsc-node-remove fa fa-times").appendTo(this.dom.titlebar),this.dom.main.prepend(this.dom.titlebar),this.dom.outputs=$("<div/>").addClass("jsc-node-outputs").appendTo(this.dom.content),this.dom.preview=$("<div/>").addClass("jsc-node-preview").appendTo(this.dom.content),this.dom.config=$("<div/>").addClass("jsc-node-config").appendTo(this.dom.content),this.dom.inputs=$("<div/>").addClass("jsc-node-inputs").appendTo(this.dom.content),this.dragstart=!1,this.mousePosX=0,this.mousePosY=0,this.nodePosX=0,this.nodePosY=0,this.newNodePosX=0,this.newNodePosY=0,this.ports={inputs:[],outputs:[]}},jsCow.res.view.node.prototype={init:function(e){this.dom.main.attr("id",e.data.id);var modelConfig=this.cmp().config();this.newNodePosX=modelConfig.pos.left,this.newNodePosY=modelConfig.pos.top,this.dom.remove.on("click",function(self,e){return function(){self.cmp().del(),self.trigger("removed",{id:e.data.id})}}(this,e)),this.trigger("view.update",e.data)},update:function(e){e.data.enabled?(this.dom.main.removeClass("jsc-node-disabled").addClass("jsc-node"),this.dom.title.html(e.data.title),this.dom.main.css("left",e.data.pos.left),this.dom.main.css("top",e.data.pos.top),this.dom.outputs.find("*").remove(),$.each(e.data.outputs,function(that){return function(i,output){var port=$("<div/>").addClass("jsc-node-port jsc-node-port-out");$("<i/>").attr("id",that.cmp().id()+"-"+output.id).appendTo(port),$("<div/>").appendTo(port).append($("<span/>").text(output.title)),that.dom.outputs.append(port)}}(this)),this.dom.inputs.find("*").remove(),$.each(e.data.inputs,function(that){return function(i,input){var port=$("<div/>").addClass("jsc-node-port jsc-node-port-in");$("<i/>").attr("id",that.cmp().id()+"-"+input.id).appendTo(port),$("<div/>").appendTo(port).append($("<span/>").text(input.title)),that.dom.inputs.append(port)}}(this)),e.data.visible?this.dom.main.show():this.dom.main.hide()):this.dom.main.removeClass("jsc-node").addClass("jsc-node-disabled")}},jsCow.res.controller.node=function(){},jsCow.res.controller.node.prototype={init:function(){this.on("model.ready",this.isModelReady),this.on("title",this.title),this.on("inputs",this.inputs),this.on("outputs",this.outputs),this.on("addInPorts",this.addInPorts)},isModelReady:function(){this.trigger("view.init",this.cmp().config())},title:function(e){this.cmp().config({title:e.data.title})},inputs:function(e){this.cmp().config({inputs:e.data.inputs})},outputs:function(e){this.cmp().config({outputs:e.data.outputs})},addInPorts:function(e){this.trigger("inputs",e.data.ports)}};